# Next Logical TUI Enhancement Analysis

## Context: Recent Commit History

The last 8 commits represent a cohesive "Agent Streaming Cleanup" initiative focused on:

1. **Tool Output Collapse** (Commits 0404f5e, f9551dd, 9193329) - Tool messages now collapse to single lines with `[N lines]` badges, expandable via click to a scrollable popup dialog
2. **Thinking/Reasoning Display** (Commits 0404f5e, 1159847, a9c4164, 9570bc7) - Full streaming pipeline for thinking content with dimmed visual styling, supporting Anthropic and OpenRouter
3. **Testing & Polish** (Commit b9d65b6) - Comprehensive unit tests for new features
4. **Noise Reduction** (Commit b5416df) - Reduced duplicate skill warnings from warn to debug

---

## Analysis: Current TUI State

### Strengths
- **Clean message collapse**: Tool outputs collapse elegantly with clickable expansion
- **Thinking transparency**: Users can see agent reasoning in real-time with appropriate visual hierarchy
- **Interactive elements**: Mouse click detection and scrollable dialogs
- **Mode switching**: Build/Plan modes with visual distinction (teal vs purple)
- **Session management**: Full session list, switching, deletion with keyboard navigation
- **Command palette**: Slash commands with autocomplete for models and commands

### Gaps & Opportunities

After analyzing the codebase, the following areas emerge as natural next steps:

1. **Code Block Rendering** - The markdown parser (`markdown.rs`) handles inline formatting (bold, italic, code, links) but **code blocks are not rendered with syntax highlighting or distinct visual treatment**. Assistant responses containing code are displayed as plain text.

2. **Assistant Message Collapse** - Tool outputs collapse but long assistant messages do not. A conversation with multiple lengthy responses becomes hard to navigate.

3. **Copy to Clipboard** - Text selection exists (`Selection` struct, `selected_text` field) but there's no mechanism to copy selected text to the clipboard.

4. **Keyboard Navigation for Tool Messages** - Tool messages are only expandable via mouse click. No keyboard-driven way to expand them.

5. **Search/Filter in Conversation** - No way to search within the current conversation history.

6. **Token/Cost Display** - `session_tokens` and `session_cost` are tracked but the cost is passed to render_session as `_session_cost` (unused).

---

## Recommendation: Enhanced Code Block Rendering

### Why This Is the Most Logical Next Step

1. **Direct continuation of visual polish work** - The last 8 commits established a pattern of improving content presentation (collapsed tools, dimmed thinking). Code blocks are the next major content type needing treatment.

2. **High impact for developer UX** - CLI tools primarily serve developers. Code is the most frequent content type in agent responses. Better code rendering directly improves the core use case.

3. **Builds on existing infrastructure** - The `markdown.rs` parser already uses `pulldown_cmark`. Code block detection is already possible; rendering is not implemented.

4. **Aligns with tool output improvements** - Code blocks could follow the same collapse pattern as tool outputs, with expandable detail view for long code.

5. **Visual coherence** - Currently, inline code has distinct styling (`CODE_COLOR`) but code blocks look like plain text. This inconsistency stands out.

---

## Proposed Enhancement: Code Block Rendering

### Features

#### 1. Fenced Code Block Detection & Syntax Highlighting
- Parse fenced code blocks (` ```language ... ``` `) from markdown
- Apply language-specific syntax highlighting using a lightweight highlighter (e.g., `syntect` or custom token-based)
- Display language label in header (e.g., "rust", "python", "bash")

#### 2. Visual Treatment
- Distinct background color for code blocks (darker panel, similar to user message panels)
- Left border accent (like user messages) to visually separate from prose
- Monospace font indication (already terminal, but add padding/structure)
- Line numbers (optional, configurable)

#### 3. Collapse for Long Code Blocks
- Code blocks over N lines (configurable, default: 15) collapse to preview
- Show first 5 lines + `[N more lines]` badge (like tool outputs)
- Click or keyboard to expand in-place or open in dialog

#### 4. Copy Code Block Action
- Add keyboard shortcut to copy code block content to clipboard
- Visual feedback on successful copy

### Implementation Approach

#### Phase 1: Basic Code Block Rendering
1. Extend `markdown.rs` to track code block state during parsing
2. Create `render_code_block()` function in `messages.rs`
3. Apply background color and left border styling
4. Display language label if specified

#### Phase 2: Collapse/Expand for Long Blocks
1. Add `DisplayMessage::CodeBlock` variant or embed code block info in `DisplayMessage::Assistant`
2. Track code block areas similar to `tool_message_areas`
3. Implement click-to-expand (reuse `ExpandedToolDialog` pattern)

#### Phase 3: Syntax Highlighting (Optional)
1. Integrate lightweight syntax highlighting crate
2. Cache highlighted output for performance
3. Support common languages: rust, python, javascript, bash, json, yaml, sql

#### Phase 4: Copy Action
1. Implement clipboard integration (via `arboard` or similar)
2. Add copy command/shortcut
3. Visual copy confirmation

---

## Alternative Considerations

### Option B: Assistant Message Collapse
- Collapse long assistant messages like tool outputs
- Lower complexity but less visual impact

### Option C: Session Token/Cost Display
- Show token usage and cost in status bar or footer
- Quick win, data already tracked

### Option D: Keyboard Navigation for Expandables
- Add `[` `]` or similar keys to navigate between expandable elements
- Press Enter to toggle expansion

---

## Recommendation Summary

**Primary Enhancement: Enhanced Code Block Rendering (Phase 1 + 2)**

This enhancement:
- Continues the visual polish trajectory of recent commits
- Addresses the most common content type in agent responses
- Provides clear UX benefits for the developer-focused user base
- Has manageable scope with well-defined phases
- Reuses patterns already established (collapse/expand, dialogs, visual hierarchy)

**Estimated Effort**: 2-3 days for Phase 1+2, additional 1-2 days for syntax highlighting

---

## Implementation Tasks (Phase 1 + 2)

### Task 1: Extend Markdown Parser for Code Blocks
- Modify `parse_markdown_line()` or create block-level parser
- Return structured representation distinguishing code blocks from prose
- Track language tag from fence

### Task 2: Create Code Block Rendering Function
- New `render_code_block()` in `messages.rs`
- Apply background color (`PANEL_BG` or similar)
- Left border accent in dimmed color
- Language label in header line

### Task 3: Integrate Code Block Rendering into Message Display
- Update `render_assistant_message_with_scroll()` to detect and route code blocks
- Handle mixed content (prose → code → prose) within single assistant message

### Task 4: Implement Collapse for Long Code Blocks
- Threshold check (e.g., > 15 lines)
- Show preview with `[N more lines]` badge
- Track code block areas for click detection

### Task 5: Add Expand Dialog/In-Place Expansion
- Reuse `ExpandedToolDialog` pattern or create `CodeBlockDialog`
- Scroll support for long code
- Esc to close

### Task 6: Add Tests
- Unit tests for code block detection
- Height calculation tests with code blocks
- Collapse threshold tests
